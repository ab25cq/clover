#######################################################
# installed directories
#######################################################
prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
datadir=@datadir@
mandir=@mandir@
libdir=@libdir@
sharedstatedir=@sharedstatedir@
sysconfdir=@sysconfdir@/clover
includedir=@includedir@/clover
datarootdir=@datarootdir@/clover
docdir=@datadir@/doc/clover

##########################################################
# environmnet variables
##########################################################
CC=@CC@
INSTALL=@INSTALL@
CFLAGS=@CFLAGS@
LIBS=@LIBS@
OBJ=@OBJ@
DESTDIR=
SO_VERSION=@SO_VERSION@
LIBSONAME=@LIBSONAME@
LIBSO2NAME=@LIBSO2NAME@
ICLOVER=@ICLOVER@

##########################################################
# main
##########################################################
all: lib int.clc cclover clover $(ICLOVER)
#	rm -f install

int.clc: cclover Fundamental.cl
	DYLD_LIBRARY_PATH=.:$(DYLD_LIBRARY_PATH) LD_LIBRARY_PATH=.:$(LD_LIBRARY_PATH) ./cclover --no-load-fundamental-classes Fundamental.cl

clover: config.h src/main.c $(LIBSONAME)
	$(CC) -o clover src/main.c $(CFLAGS:-static=) -lclover $(LIBS)

$(ICLOVER): config.h src/interpreter.c $(LIBSONAME)
	$(CC) -o iclover src/interpreter.c $(CFLAGS:-static=) -lclover $(LIBS)

cclover: config.h src/compiler.c $(LIBSONAME)
	$(CC) -o cclover src/compiler.c $(CFLAGS:-static=) -lclover $(LIBS)

lib: $(LIBSONAME)
#	rm -f install

lib-install:
	if [ -z "$(DESTDIR)" ]; then make lib-normal-install; else make lib-dest-install; fi

lib-normal-install:
	mkdir -p "$(libdir)"
	if [ $(LIBSONAME) = libclover.so ]; then if echo $(CFLAGS) | grep -q MDEBUG; then $(INSTALL) -m 755 libclover.so.$(SO_VERSION) "$(libdir)"; else $(INSTALL) -s -m 755 libclover.so.$(SO_VERSION) "$(libdir)"; fi; elif [ $(LIBSONAME) = libclover.dylib ]; then $(INSTALL) -m 755 libclover.$(SO_VERSION).dylib "$(libdir)"; fi
	if [ $(LIBSONAME) = libclover.so ]; then ln -s -f libclover.so.$(SO_VERSION) "$(libdir)"/libclover.so.1; elif [ $(LIBSONAME) = libclover.dylib ]; then ln -s -f libclover.$(SO_VERSION).dylib "$(libdir)"/libclover.1.dylib; fi
	if [ $(LIBSONAME) = libclover.so ]; then ln -s -f libclover.so.$(SO_VERSION) "$(libdir)"/libclover.so; elif [ $(LIBSONAME) = libclover.dylib ]; then ln -s -f libclover.$(SO_VERSION).dylib "$(libdir)"/libclover.dylib; fi

lib-dest-install:
	mkdir -p "$(DESTDIR)/$(libdir)"
	if [ "$(LIBSONAME)" = libclover.so ]; then if echo $(CFLAGS) | grep -q MDEBUG; then $(INSTALL) -m 755 libclover.so.$(SO_VERSION) "$(DESTDIR)/$(libdir)"; else $(INSTALL) -s -m 755 libclover.so.$(SO_VERSION) "$(DESTDIR)/$(libdir)"; fi; elif [ "$(LIBSONAME)" = libclover.dylib ]; then $(INSTALL) -m 755 libclover.$(SO_VERSION).dylib "$(DESTDIR)/$(libdir)"; fi
	if [ "$(LIBSONAME)" = libclover.so ]; then ln -s -f libclover.so.$(SO_VERSION) "$(DESTDIR)/$(libdir)"/libclover.so.1; elif [ "$(LIBSONAME)" = libclover.dylib ]; then ln -s -f libclover.$(SO_VERSION).dylib "$(DESTDIR)/$(libdir)"/libclover.1.dylib; fi
	if [ "$(LIBSONAME)" = libclover.so ]; then ln -s -f libclover.so.$(SO_VERSION) "$(DESTDIR)/$(libdir)"/libclover.so; elif [ "$(LIBSONAME)" = libclover.dylib ]; then ln -s -f libclover.$(SO_VERSION).dylib "$(DESTDIR)/$(libdir)"/libclover.dylib; fi

########################################################
# clover libraries
########################################################
libclover.so.$(SO_VERSION): $(OBJ)
	gcc -shared -o libclover.so.$(SO_VERSION) $(OBJ) -lc $(LIBS) $(CFLAGS)

libclover.so: libclover.so.$(SO_VERSION)
	ln -s -f libclover.so.$(SO_VERSION) libclover.so.1
	ln -s -f libclover.so.$(SO_VERSION) libclover.so

########################################################
# clover libraries on Darwin
########################################################
libclover.$(SO_VERSION).dylib: $(OBJ)
	gcc -dynamiclib -o libclover.$(SO_VERSION).dylib $(OBJ) -lc $(LIBS) $(CFLAGS)

libclover.dylib: libclover.$(SO_VERSION).dylib
	cp libclover.$(SO_VERSION).dylib libclover.1.dylib
	cp libclover.$(SO_VERSION).dylib libclover.dylib

#########################################################
# Object files
#########################################################
$(OBJ): src/*.h Makefile configure

#########################################################
# install
#########################################################
install: lib-install
	if [ -z "$(DESTDIR)" ]; then make normal-install; else make dest-install; fi

normal-install:
	mkdir -p "$(bindir)"
	mkdir -p "$(sysconfdir)"
	mkdir -p "$(libdir)"
	mkdir -p "$(includedir)"
	mkdir -p "$(docdir)"
	mkdir -p "$(mandir)/man1"
	$(INSTALL) -m 644 src/clover.h "$(includedir)"
	$(INSTALL) -m 644 USAGE "$(docdir)"
	$(INSTALL) -m 644 README "$(docdir)"
	$(INSTALL) -m 644 CHANGELOG "$(docdir)"
	$(INSTALL) -m 644 man/man1/clover.1 "$(mandir)/man1"
	$(INSTALL) -m 644 int.clc "$(datarootdir)"
	$(INSTALL) -m 644 float.clc "$(datarootdir)"
	$(INSTALL) -m 644 void.clc "$(datarootdir)"
	$(INSTALL) -m 644 String.clc "$(datarootdir)"
	$(INSTALL) -m 644 Clover.clc "$(datarootdir)"
	$(INSTALL) -m 644 Object.clc "$(datarootdir)"
	$(INSTALL) -m 644 Array.clc "$(datarootdir)"
	$(INSTALL) -m 644 Hash.clc "$(datarootdir)"
	rm -f $(bindir)/clover
	if echo $(CFLAGS) | grep -q MDEBUG; then $(INSTALL) -m 755 clover "$(bindir)"; else $(INSTALL) -s -m 755 clover "$(bindir)"; fi;
	rm -f $(bindir)/cclover
	if echo $(CFLAGS) | grep -q MDEBUG; then $(INSTALL) -m 755 cclover "$(bindir)"; else $(INSTALL) -s -m 755 cclover "$(bindir)"; fi;
	rm -f $(bindir)/iclover
	if test -e ./iclover; then $(INSTALL) -m 755 iclover "$(bindir)"; fi

dest-install:
	mkdir -p "$(DESTDIR)/$(bindir)";
	mkdir -p "$(DESTDIR)/$(sysconfdir)";
	mkdir -p "$(DESTDIR)/$(libdir)"
	mkdir -p "$(DESTDIR)/$(includedir)"
	mkdir -p "$(DESTDIR)/$(docdir)"
	mkdir -p "$(DESTDIR)/$(mandir)/man1"
	$(INSTALL) -m 644 src/clover.h "$(DESTDIR)/$(includedir)"
	$(INSTALL) -m 644 USAGE "$(DESTDIR)/$(docdir)"
	$(INSTALL) -m 644 README "$(DESTDIR)/$(docdir)"
	$(INSTALL) -m 644 CHANGELOG "$(DESTDIR)/$(docdir)"
	$(INSTALL) -m 644 man/man1/clover.1 "$(DESTDIR)/$(mandir)/man1"
	$(INSTALL) -m 644 int.clc "$(datarootdir)"
	$(INSTALL) -m 644 void.clc "$(datarootdir)"
	$(INSTALL) -m 644 float.clc "$(datarootdir)"
	$(INSTALL) -m 644 String.clc "$(datarootdir)"
	$(INSTALL) -m 644 Clover.clc "$(datarootdir)"
	$(INSTALL) -m 644 Object.clc "$(datarootdir)"
	$(INSTALL) -m 644 Array.clc "$(datarootdir)"
	$(INSTALL) -m 644 Hash.clc "$(datarootdir)"
	rm -f "$(DESTDIR)/$(bindir)/clover"
	if echo $(CFLAGS) | grep -q MDEBUG; then $(INSTALL) -m 755 clover "$(DESTDIR)/$(bindir)"; else $(INSTALL) -s -m 755 clover "$(DESTDIR)/$(bindir)"; fi;
	rm -f "$(DESTDIR)/$(bindir)/cclover"
	if echo $(CFLAGS) | grep -q MDEBUG; then $(INSTALL) -m 755 cclover "$(DESTDIR)/$(bindir)"; else $(INSTALL) -s -m 755 cclover "$(DESTDIR)/$(bindir)"; fi;
	rm -f "$(DESTDIR)/$(bindir)/iclover"
	if test -e ./iclover; then $(INSTALL) -m 755 iclover "$(DESTDIR)/$(bindir)"; fi

#########################################################
# uninstall
#########################################################
uninstall:
	rm -f $(includedir)/clover.h
	rmdir $(includedir)
	rm -f $(docdir)/USAGE
	rm -f $(docdir)/README
	rm -f $(docdir)/CHANGELOG
	rmdir $(docdir)
	rm -f $(mandir)/man1/clover.1
	rm -f $(datarootdir)/int.clc
	rm -f $(datarootdir)/void.clc
	rm -f $(datarootdir)/float.clc
	rm -f $(datarootdir)/String.clc
	rm -f $(datarootdir)/Clover.clc
	rm -f $(datarootdir)/Object.clc
	rm -f $(datarootdir)/Array.clc
	rm -f $(datarootdir)/Hash.clc
	rm -f $(datarootdir)/anonymous0.clc
	rm -f $(datarootdir)/anonymous1.clc
	rm -f $(datarootdir)/anonymous2.clc
	rm -f $(datarootdir)/anonymous3.clc
	rm -f $(datarootdir)/anonymous4.clc
	rm -f $(datarootdir)/anonymous5.clc
	rm -f $(datarootdir)/anonymous6.clc
	rm -f $(datarootdir)/anonymous7.clc
	rmdir $(datarootdir)
	rm -f $(bindir)/clover
	rm -f $(bindir)/iclover
	rm -f $(bindir)/cclover

#########################################################
# permission
#########################################################
permission:
	chmod 644 *
	chmod 755 .git man src configure
	chmod 644 src/*.c
	chmod 644 src/*.h

#########################################################
# test
#########################################################
test:
	@echo "Start to test compile and running code..."
	@echo "--- Hello World.cl ---"
	clover code/HelloWorld.clm
	@echo "--- AccessorMethod.cl ---"
	cclover code/AccessorMethod.cl && clover code/AccessorMethod.clm
	@echo OK
	@echo "--- ExtendsAndClassMethod.cl ---"
	cclover code/ExtendsAndClassMethod.cl && clover code/ExtendsAndClassMethod.clm
	@echo OK
	@echo "--- New.cl ---"
	cclover code/New.cl && clover code/New.clm
	@echo OK
	@echo "--- Extends.cl ---"
	cclover code/Extends.cl && clover code/Extends.clm
	@echo OK
	@echo "--- Generics.cl ---"
	cclover code/Generics.cl && clover code/Generics.clm
	@echo OK
	@echo "--- Inherit ---"
	cclover code/Inherit.cl && clover code/Inherit.clm
	@echo OK
	@echo "--- NameSpace ---"
	cclover code/NameSpace.cl && clover code/NameSpace.clm
	@echo OK
	@echo "--- OpenClass ---"
	cclover code/OpenClass.cl && clover code/OpenClass.clm
	@echo OK
	@echo "--- Array ---"
	clover code/Array.clm
	@echo OK
	@echo "--- OperatorMethod.cl ---"
	cclover code/OperatorMethod.cl && clover code/OperatorMethod.clm
	@echo OK
	@echo "--- Operand.cl ---"
	cclover code/Operand.cl && clover code/Operand.clm
	@echo "--- if_test.clm ---"
	clover code/if_test.clm
	@echo "--- while_test.clm ---"
	clover code/while_test.clm
	@echo "--- qmark_operator.clm ---"
	clover code/qmark_operator.clm
	@echo "--- continue_test.clm ---"
	clover code/continue_test.clm
	@echo "--- method_with_block.clm ---"
	cclover code/method_with_block.cl && clover code/method_with_block.clm
	@echo "--- output_to_s.clm ---"
	clover code/output_to_s.clm
	@echo "--- new_test.clm ---"
	cclover code/new_test.cl && clover code/new_test.clm
	@echo "--- super_with_block.cl ---"
	cclover code/super_with_block.cl && clover code/super_with_block.clm
	@echo "--- inherit_with_block.cl ---"
	cclover code/inherit_with_block.cl && clover code/inherit_with_block.clm
	@echo "--- revert_from_method_block.cl ---"
	cclover code/revert_from_method_block.cl && clover code/revert_from_method_block.clm

########################################################
# clean
########################################################
clean:
	rm -fR clover clover.dSYM cclover cclover.dSYM iclover iclover.dSYM src/*.o libclover* clover.exe* config.log config.status *.stackdump autom4te.cache .DS_Store test/*.clc *.clc code/*.class code/*.exe debug.log

distclean:
	rm -fR a.out clover clover.dSYM cclover cclover.dSYM iclover iclover.dSYM src/*.o libclover* config.h Makefile clover.exe* config.log config.status *.stackdump autom4te.cache .DS_Store test/*.clc *.clc code/*.class code/*.exe debug.log

